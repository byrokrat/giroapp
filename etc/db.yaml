parameters:
    db.donors: '%fs.internal_data_dir%/donors.json'
    db.imports: '%fs.internal_data_dir%/imports.json'
    db.log: '%fs.external_data_dir%/log'

services:
    _defaults:
        public: false
        autowire: true

    byrokrat\giroapp\Mapper\:
        resource: '../src/Mapper/*'

    flysystem_user_dir:
        class: League\Flysystem\Filesystem
        arguments: ['@flysystem_user_dir_adapter']
        configurator: 'byrokrat\giroapp\Mapper\FlysystemConfigurator:createFiles'

    flysystem_user_dir_adapter:
        class: League\Flysystem\Adapter\Local
        arguments: ['%fs.user_dir%']

    byrokrat\giroapp\Mapper\FlysystemConfigurator:
        class: ~
        arguments:
            -
                - '%db.donors%'
                - '%db.log%'
                - '%db.imports%'

    db:
        class: hanneskod\yaysondb\Yaysondb
        arguments:
            -
                donors: '@db_donor_engine'
                imports: '@db_import_engine'
                log: '@db_log_engine'

    byrokrat\giroapp\Mapper\DonorMapper:
        class: ~
        arguments: ['@db_donor_collection']

    db_donor_collection:
        class: hanneskod\yaysondb\Collection
        arguments: ['@db_donor_engine']

    db_donor_engine:
        class: hanneskod\yaysondb\Engine\FlysystemEngine
        arguments: ['%db.donors%', '@flysystem_user_dir']

    db_log_collection:
        class: hanneskod\yaysondb\Collection
        arguments: ['@db_log_engine']

    db_log_engine:
        class: hanneskod\yaysondb\Engine\LogEngine
        arguments: ['%fs.user_dir%/%db.log%', '@byrokrat\giroapp\Mapper\LogFormatter']

    byrokrat\giroapp\Mapper\FileChecksumMapper:
        class: ~
        arguments: ['@db_import_collection']

    db_import_collection:
        class: hanneskod\yaysondb\Collection
        arguments: ['@db_import_engine']

    db_import_engine:
        class: hanneskod\yaysondb\Engine\FlysystemEngine
        arguments: ['%db.imports%', '@flysystem_user_dir']
