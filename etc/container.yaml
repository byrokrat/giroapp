parameters:
    user.dir: '%env(GIROAPP_PATH)%'
    plugins.dir: 'plugins'

imports:
    - { resource: db.yaml }
    - { resource: fs.yaml }

services:
    _defaults:
        autowire: true

    output:
        synthetic: true

    event_dispatcher:
        class: Symfony\Component\EventDispatcher\EventDispatcher
        configurator: 'byrokrat\giroapp\DI\PluginLoader:loadPlugins'

    byrokrat\giroapp\DI\PluginLoader:
        class: ~
        arguments: ['%user.dir%/%plugins.dir%', '@filesystem']

    byrokrat\giroapp\ApplicationMonitor:
        class: ~
        tags:
            - { name: event_subscriber }

    byrokrat\giroapp\Listener\LoggingListener:
        class: ~
        arguments: ['@db_log_collection']
        tags:
            - { name: event_listener, event: ERROR_EVENT, method: onLogEvent, priority: 10 }
            - { name: event_listener, event: WARNING_EVENT, method: onLogEvent, priority: 10 }
            - { name: event_listener, event: INFO_EVENT, method: onLogEvent, priority: 10 }

    byrokrat\giroapp\Listener\OutputtingListener:
        class: ~
        arguments: ['@output']
        tags:
            - { name: event_listener, event: ERROR_EVENT, priority: -10 }
            - { name: event_listener, event: WARNING_EVENT, priority: -10 }
            - { name: event_listener, event: INFO_EVENT, priority: -10 }
            - { name: event_listener, event: DEBUG_EVENT, priority: -10 }

    byrokrat\giroapp\Listener\ImportListener:
        class: ~
        tags:
            - { name: event_listener, event: IMPORT_EVENT, priority: 9 }

    byrokrat\giroapp\Listener\InvalidNodeFilteringListener:
        class: ~
        tags:
            - { name: event_listener, event: MANDATE_RESPONSE_EVENT, priority: 10 }

    byrokrat\giroapp\Listener\CommittingListener:
        class: ~
        arguments: ['@db']
        tags:
            - { name: event_listener, event: EXECUTION_END_EVENT, priority: 1 }

    byrokrat\giroapp\Listener\MandateResponseListener:
        class: ~
        tags:
            - { name: event_listener, event: MANDATE_RESPONSE_EVENT, priority: 1 }

    byrokrat\giroapp\Builder\:
        resource: '../src/Builder/*'

    byrokrat\giroapp\Model\DonorState\:
        resource: '../src/Model/DonorState/*'

    byrokrat\autogiro\Parser\ParserFactory: ~

    byrokrat\autogiro\Parser\Parser:
        factory: 'byrokrat\autogiro\Parser\ParserFactory:createParser'

    byrokrat\banking\BankgiroFactory: ~

    byrokrat\banking\AccountFactory: ~

    byrokrat\id\IdFactory:
        class: byrokrat\id\PersonalIdFactory
        autowire: false
