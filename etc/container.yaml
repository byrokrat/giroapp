parameters:
    plugins.dir: 'plugins'

imports:
    - { resource: db.yaml }
    - { resource: fs.yaml }

services:
    event_dispatcher:
        class: Symfony\Component\EventDispatcher\EventDispatcher
        configurator: 'plugin_loader:loadPlugins'

    plugin_loader:
        class: byrokrat\giroapp\DI\PluginLoader
        arguments: ['%user.dir%/%plugins.dir%', '@filesystem']

    logging_listener:
        class: byrokrat\giroapp\Listener\LoggingListener
        arguments: ['@db_log_collection']
        tags:
            - { name: event_listener, event: ERROR_EVENT, method: onLogEvent, priority: 10 }
            - { name: event_listener, event: WARNING_EVENT, method: onLogEvent, priority: 10 }
            - { name: event_listener, event: INFO_EVENT, method: onLogEvent, priority: 10 }

    outputting_listener:
        class: byrokrat\giroapp\Listener\OutputtingListener
        arguments: ['@output']
        tags:
            - { name: event_listener, event: ERROR_EVENT, priority: -10 }
            - { name: event_listener, event: WARNING_EVENT, priority: -10 }
            - { name: event_listener, event: INFO_EVENT, priority: -10 }
            - { name: event_listener, event: DEBUG_EVENT, priority: -10 }

    import_listener:
        class: byrokrat\giroapp\Listener\ImportingListener
        tags:
            - { name: event_listener, event: IMPORT_EVENT, priority: 9 }

    import_autogiro_listener:
        class: byrokrat\giroapp\Listener\ImportingAutogiroListener
        arguments: ["@=service('autogiro_parser_factory').createParser()"]
        tags:
            - { name: event_listener, event: IMPORT_AUTOGIRO_EVENT, priority: 9 }

    import_xml_listener:
        class: byrokrat\giroapp\Listener\ImportingXmlListener
        arguments: ['@xml_mandate_parser']
        tags:
            - { name: event_listener, event: IMPORT_XML_EVENT, priority: 9 }

    invalid_node_filtering_listener:
        class: byrokrat\giroapp\Listener\InvalidNodeFilteringListener
        arguments: ['@bankgiro_factory', '@settings_mapper']
        tags:
            - { name: event_listener, event: MANDATE_RESPONSE_EVENT, priority: 10 }

    comitting_listener:
        class: byrokrat\giroapp\Listener\CommittingListener
        arguments: ['@db_handle']
        tags:
            - { name: event_listener, event: EXECUTION_END_EVENT, priority: 1 }

    mandate_persisting_listener:
        class: byrokrat\giroapp\Listener\MandatePersistingListener
        arguments: ['@donor_mapper']
        tags:
            - { name: event_listener, event: MANDATE_ADDED_EVENT, priority: 10 }

    mandate_response_listener:
        class: byrokrat\giroapp\Listener\MandateResponseListener
        arguments: ['@donor_mapper']
        tags:
            - { name: event_listener, event: MANDATE_RESPONSE_EVENT, priority: 1 }

    application_monitior:
        class: byrokrat\giroapp\ApplicationMonitor
        tags:
            - { name: event_subscriber }

    autogiro_parser_factory:
        class: byrokrat\autogiro\Parser\ParserFactory

    bankgiro_factory:
        class: byrokrat\banking\BankgiroFactory

    account_factory:
        class: byrokrat\banking\AccountFactory

    id_factory:
        class: byrokrat\id\PersonalIdFactory
        arguments: ['@organization_id_factory']

    organization_id_factory:
        class: byrokrat\id\OrganizationIdFactory

    donor_builder:
        class: byrokrat\giroapp\Builder\DonorBuilder
        arguments: ['@mandate_key_builder']

    mandate_key_builder:
        class: byrokrat\giroapp\Builder\MandateKeyBuilder

    xml_mandate_parser:
        class: byrokrat\giroapp\Xml\XmlMandateParser
        arguments:
            - '@organization_id'
            - '@organization_bg'
            - '@donor_builder'
            - '@customdata_translator'
            - '@account_factory'
            - '@id_factory'

    customdata_translator:
        class: byrokrat\giroapp\Xml\CustomdataTranslator
        arguments: ['@null_xml_mandate_migation']

    null_xml_mandate_migation:
        class: byrokrat\giroapp\Xml\NullXmlMandateMigation

    organization_id:
        class: byrokrat\id\Id
        factory: 'id_factory:create'
        arguments: ["@=service('settings_mapper').findByKey('org_number')"]

    organization_bg:
        class: byrokrat\banking\AccountNumber
        factory: 'bankgiro_factory:createAccount'
        arguments: ["@=service('settings_mapper').findByKey('bankgiro')"]
